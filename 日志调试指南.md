# 日志调试指南

已为项目添加详细的日志记录功能，帮助定位 404 和其他问题。

## 📋 日志功能

### 1. 日志文件
- **日志文件位置**: `app.log`（项目根目录）
- **日志级别**: INFO（包含 DEBUG 信息）
- **日志格式**: 时间戳 - 模块名 - 级别 - 消息

### 2. 日志内容

#### 请求日志
每次请求都会记录：
- 请求方法（GET/POST 等）
- 请求路径
- 完整 URL
- 查询参数
- 请求头（排除敏感信息）
- 客户端 IP

#### 响应日志
- HTTP 状态码
- 处理时间
- 如果是 404，会记录所有可用路由

#### 错误日志
- 详细的错误堆栈信息
- 异常发生的位置

## 🔍 如何查看日志

### 方法 1：查看日志文件

```bash
# Windows PowerShell
Get-Content app.log -Tail 50

# Windows CMD
type app.log

# Linux/Mac
tail -f app.log
```

### 方法 2：实时查看日志（Docker）

```bash
# 查看所有服务日志
docker-compose logs -f

# 只查看后端服务日志
docker-compose logs -f backend

# 查看最近 100 行
docker-compose logs --tail=100 backend
```

### 方法 3：在控制台查看

如果服务直接运行（非 Docker），日志会同时输出到控制台和文件。

## 🐛 定位 404 错误

### 步骤 1：查看日志文件

当出现 404 错误时，日志会记录：

```
WARNING - 404 错误 - 路径不存在: /错误的路径
WARNING - 完整 URL: http://...
WARNING - 可用路由 (X 个): ['GET /', 'POST /api/alert', ...]
```

### 步骤 2：检查请求路径

常见问题：
1. **路径拼写错误**
   - ❌ `/api/alerts` (错误)
   - ✅ `/api/alert` (正确)

2. **缺少前缀**
   - ❌ `/alert`
   - ✅ `/api/alert`

3. **多余斜杠**
   - ❌ `/api/alert/`
   - ✅ `/api/alert`

### 步骤 3：使用调试端点

访问调试端点查看所有可用路由：

```bash
curl http://localhost:8000/debug/routes
```

或在浏览器中打开：
```
http://localhost:8000/debug/routes
```

返回示例：
```json
{
  "total_routes": 6,
  "routes": [
    {
      "path": "/",
      "methods": {"GET"},
      "name": "root"
    },
    {
      "path": "/api/alert",
      "methods": {"POST"},
      "name": "receive_alert"
    },
    ...
  ]
}
```

## 📝 日志示例

### 正常请求日志

```
2025-12-11 11:42:49,123 - __main__ - INFO - 收到请求: POST /api/alert
2025-12-11 11:42:49,124 - __main__ - DEBUG - 请求详情: {
  "timestamp": "2025-12-11T11:42:49.123456",
  "method": "POST",
  "url": "http://localhost:8000/api/alert",
  "path": "/api/alert",
  "query_params": {},
  "headers": {...},
  "client": "127.0.0.1"
}
2025-12-11 11:42:49,125 - __main__ - INFO - 收到告警数据: 企业=KrediOne CG, 类型=告警触发
2025-12-11 11:42:49,200 - __main__ - INFO - 成功创建告警记录: ID=1
2025-12-11 11:42:49,201 - __main__ - INFO - 响应: POST /api/alert - 200 (0.078s)
```

### 404 错误日志

```
2025-12-11 11:42:49,123 - __main__ - INFO - 收到请求: POST /api/alerts
2025-12-11 11:42:49,124 - __main__ - INFO - 响应: POST /api/alerts - 404 (0.001s)
2025-12-11 11:42:49,125 - __main__ - WARNING - 404 错误 - 路径不存在: /api/alerts
2025-12-11 11:42:49,126 - __main__ - WARNING - 完整 URL: http://localhost:8000/api/alerts
2025-12-11 11:42:49,127 - __main__ - WARNING - 可用路由 (6 个): ['GET /', 'POST /api/alert', 'GET /api/alerts', 'GET /api/alerts/{alert_id}', 'GET /health', 'GET /debug/routes']
```

## 🔧 常见问题排查

### 问题 1：404 错误

**症状**: 返回 404 状态码

**排查步骤**:
1. 查看日志文件中的 "404 错误" 警告
2. 检查请求路径是否正确
3. 查看 "可用路由" 列表，确认正确的路径
4. 使用 `/debug/routes` 端点查看所有路由

**解决方案**:
- 确保使用正确的路径（注意单复数）
- POST 请求使用 `/api/alert`（单数）
- GET 请求使用 `/api/alerts`（复数）

### 问题 2：请求体解析错误

**症状**: 422 错误（Unprocessable Entity）

**排查步骤**:
1. 查看日志中的请求详情
2. 检查请求体的 JSON 格式
3. 确认所有必需字段都存在

**解决方案**:
- 检查 JSON 格式是否正确
- 确认字段名拼写正确
- 查看 `models.py` 中的 `AlertInput` 模型定义

### 问题 3：数据库连接错误

**症状**: 500 错误，日志中有数据库相关错误

**排查步骤**:
1. 查看日志文件中的错误堆栈
2. 检查数据库服务是否运行
3. 检查数据库连接配置

**解决方案**:
- 确保 PostgreSQL 服务已启动（Docker: `docker-compose ps`）
- 检查 `.env` 文件中的 `DATABASE_URL`
- 查看数据库日志：`docker-compose logs postgres`

## 📊 日志级别说明

- **DEBUG**: 详细的调试信息（请求详情等）
- **INFO**: 一般信息（请求/响应、业务操作）
- **WARNING**: 警告信息（404 错误、配置问题）
- **ERROR**: 错误信息（异常、处理失败）

## 🎯 快速调试命令

```bash
# 查看最近的错误
grep ERROR app.log | tail -20

# 查看所有 404 错误
grep "404 错误" app.log

# 查看特定路径的请求
grep "/api/alert" app.log

# 查看今天的日志
grep "$(date +%Y-%m-%d)" app.log
```

## 💡 提示

1. **日志文件大小**: 日志会持续写入，建议定期清理或使用日志轮转
2. **敏感信息**: 日志中已排除 Authorization 和 Cookie 头
3. **性能影响**: 日志记录对性能影响很小，可以放心使用
4. **生产环境**: 生产环境建议调整日志级别为 WARNING 或 ERROR

## 🔄 重启服务查看新日志

如果修改了代码，需要重启服务：

```bash
# Docker 方式
docker-compose restart backend

# 本地方式
# 停止当前服务（Ctrl+C），然后重新运行
python main.py
```


