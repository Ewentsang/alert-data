# 排查超时未触发 Dify Workflow 的详细步骤

## 检查清单

### 步骤 1：确认服务已重启

**问题**：代码已修改，但服务可能还在运行旧代码

**检查方法**：
```powershell
# 查看服务状态
docker-compose ps

# 重启服务
docker-compose restart backend
```

### 步骤 2：检查数据库记录类型

**问题**：从图片看，`om_type` 显示为"告警触发"，但应该检查 `alert_type` 字段

**在数据库中执行**：
```sql
SELECT 
    id,
    alert_type,  -- 这个字段应该是"告警触发"
    om_type,     -- 这个字段是 OM 类型，不是告警类型
    enterprise_name,
    alert_key,
    processed,
    timeout_triggered,
    time,
    created_at,
    -- 计算距离现在的时间（分钟）
    EXTRACT(EPOCH FROM (NOW() - time))/60 as minutes_since_alert
FROM alerts
WHERE alert_key = '企业 SHEIN 的420错误率超过阈值'
ORDER BY created_at DESC;
```

**确认**：
- `alert_type` 必须是 `'告警触发'`
- `processed` 必须是 `false`
- `timeout_triggered` 必须是 `false`
- `minutes_since_alert` 应该大于 20

### 步骤 3：检查配置是否正确加载

**检查方法**：
```powershell
# 查看日志，确认配置
docker-compose logs backend --tail 100 | Select-String -Pattern "DIFY|API_KEY|未配置"
```

**应该看到**：
- 如果有 `未配置 DIFY_WEBHOOK_URL_TIMEOUT`，说明配置未加载
- 如果有 `未配置 DIFY_API_KEY`，说明 API Key 未配置

### 步骤 4：检查定期检查任务是否运行

**查看日志**：
```powershell
# 查看最近的日志
docker-compose logs backend --tail 200

# 搜索定期检查相关日志
docker-compose logs backend | Select-String -Pattern "定期检查|找到.*个可能超时|告警触发超时"
```

**应该看到**：
- `找到 X 个可能超时的告警触发记录` - 说明定期检查在运行
- `告警触发超时: ID=...` - 说明检测到超时
- `发送超时通知到 Dify workflow` - 说明正在发送

### 步骤 5：检查是否有错误

**查看错误日志**：
```powershell
# 查看所有错误
docker-compose logs backend | Select-String -Pattern "ERROR|错误|Exception"
```

### 步骤 6：手动触发检查（测试）

如果记录已经超过 20 分钟，可以：

1. **等待下一个检查周期**（每 60 秒检查一次）

2. **或者临时修改检查间隔**（加快检查频率）：
   - 在 `.env` 文件中设置：`CHECK_INTERVAL_SECONDS=10`
   - 重启服务：`docker-compose restart backend`
   - 等待 10 秒后查看日志

3. **或者重启服务**（会立即触发一次检查）

## 常见问题

### Q1: 为什么旧记录没有自动更新？

**A**: 
- 旧记录是在代码修改之前创建的
- 定期检查任务每 60 秒运行一次
- 需要等待下一个检查周期才会处理

**解决方案**：
- 重启服务（会立即触发检查）
- 或等待 1-2 分钟

### Q2: 配置了但日志显示"未配置"？

**A**: 可能的原因：
1. `.env` 文件未正确加载
2. 服务未重启
3. 环境变量名称拼写错误

**检查方法**：
```powershell
# 查看 .env 文件
Get-Content .env | Select-String "DIFY"

# 查看容器中的环境变量
docker-compose exec backend sh -c "env | grep DIFY"
```

### Q3: 日志中没有看到定期检查的信息？

**A**: 可能的原因：
1. 日志级别设置问题
2. 定期检查任务没有启动
3. 没有符合条件的记录

**检查方法**：
```sql
-- 检查是否有符合条件的记录
SELECT COUNT(*) as count
FROM alerts
WHERE alert_type = '告警触发'
  AND processed = false
  AND timeout_triggered = false
  AND time <= NOW() - INTERVAL '20 minutes';
```

## 快速诊断命令

### 一键检查脚本

在 PowerShell 中执行：

```powershell
# 1. 检查服务状态
Write-Host "=== 服务状态 ===" -ForegroundColor Green
docker-compose ps

# 2. 检查最近的日志
Write-Host "`n=== 最近50行日志 ===" -ForegroundColor Green
docker-compose logs backend --tail 50

# 3. 检查配置相关日志
Write-Host "`n=== 配置相关日志 ===" -ForegroundColor Green
docker-compose logs backend | Select-String -Pattern "DIFY|API_KEY|未配置|超时" | Select-Object -Last 10

# 4. 检查错误日志
Write-Host "`n=== 错误日志 ===" -ForegroundColor Red
docker-compose logs backend | Select-String -Pattern "ERROR|错误|Exception" | Select-Object -Last 10
```

## 立即解决方案

如果确认记录已经超过 20 分钟：

1. **重启服务**（最快速）：
   ```powershell
   docker-compose restart backend
   ```

2. **等待 1-2 分钟**，然后查看日志：
   ```powershell
   docker-compose logs backend --tail 100
   ```

3. **检查数据库**，确认字段是否更新：
   ```sql
   SELECT id, processed, timeout_triggered, updated_at
   FROM alerts
   WHERE alert_key = '企业 SHEIN 的420错误率超过阈值';
   ```


