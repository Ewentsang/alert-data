# 修改数据库字段指南

## 方法一：使用 Alembic 数据库迁移（推荐）✅

这是最安全和专业的方法，适合生产环境。

### 1. 初始化 Alembic（如果还没初始化）

```bash
alembic init alembic
```

**注意：** 项目已经包含了 Alembic 配置，可以直接使用。

### 2. 修改数据库模型

编辑 `database.py` 文件，修改 `Alert` 类的字段。

**示例：添加新字段**

```python
class Alert(Base):
    # ... 现有字段 ...
    
    # 添加新字段
    priority = Column(String(20), default="normal")  # 优先级
    notify_count = Column(Integer, default=0)  # 通知次数
```

**示例：修改现有字段**

```python
# 修改字段类型或长度
enterprise_name = Column(String(500), index=True)  # 从 200 增加到 500
```

**示例：添加索引**

```python
time = Column(DateTime, index=True)  # 已经有索引
# 或添加复合索引
```

### 3. 生成迁移脚本

```bash
# 自动检测模型变化并生成迁移脚本
alembic revision --autogenerate -m "添加优先级字段"
```

这会创建一个新的迁移文件在 `alembic/versions/` 目录下。

### 4. 检查迁移脚本

打开生成的迁移文件，检查 `upgrade()` 和 `downgrade()` 函数是否正确。

**示例迁移文件内容：**

```python
def upgrade() -> None:
    # 添加新字段
    op.add_column('alerts', sa.Column('priority', sa.String(length=20), server_default='normal', nullable=True))
    op.add_column('alerts', sa.Column('notify_count', sa.Integer(), server_default='0', nullable=True))

def downgrade() -> None:
    # 删除字段（回滚时使用）
    op.drop_column('alerts', 'notify_count')
    op.drop_column('alerts', 'priority')
```

### 5. 执行迁移

```bash
# 应用迁移到数据库
alembic upgrade head
```

### 6. 验证更改

在 DBeaver 中刷新表结构，查看新字段是否已添加。

### 常用 Alembic 命令

```bash
# 查看当前数据库版本
alembic current

# 查看迁移历史
alembic history

# 升级到最新版本
alembic upgrade head

# 降级一个版本
alembic downgrade -1

# 升级到指定版本
alembic upgrade <revision_id>

# 生成空迁移（手动编写）
alembic revision -m "描述"
```

---

## 方法二：直接修改模型 + 重新创建（简单但会丢失数据）⚠️

**⚠️ 警告：此方法会删除所有现有数据！**

### 1. 备份数据（重要！）

在 DBeaver 中执行：

```sql
-- 导出数据
COPY alerts TO '/tmp/alerts_backup.csv' WITH CSV HEADER;
```

### 2. 删除表

```sql
DROP TABLE alerts;
```

### 3. 修改 `database.py` 中的模型

### 4. 重启服务，让表自动创建

```bash
docker-compose restart backend
```

### 5. 恢复数据（如果有备份）

---

## 方法三：手动执行 SQL（适合小改动）✅

直接在 DBeaver 中执行 SQL 语句。

### 添加新字段

```sql
-- 添加单个字段
ALTER TABLE alerts 
ADD COLUMN priority VARCHAR(20) DEFAULT 'normal';

-- 添加多个字段
ALTER TABLE alerts 
ADD COLUMN priority VARCHAR(20) DEFAULT 'normal',
ADD COLUMN notify_count INTEGER DEFAULT 0;
```

### 修改字段类型

```sql
-- 修改字段类型
ALTER TABLE alerts 
ALTER COLUMN enterprise_name TYPE VARCHAR(500);

-- PostgreSQL 修改字段长度
ALTER TABLE alerts 
ALTER COLUMN enterprise_name TYPE VARCHAR(500) 
USING enterprise_name::VARCHAR(500);
```

### 修改字段默认值

```sql
ALTER TABLE alerts 
ALTER COLUMN processed SET DEFAULT false;
```

### 重命名字段

```sql
ALTER TABLE alerts 
RENAME COLUMN old_name TO new_name;
```

### 删除字段

```sql
ALTER TABLE alerts 
DROP COLUMN column_name;
```

### 添加索引

```sql
-- 添加普通索引
CREATE INDEX idx_alerts_priority ON alerts(priority);

-- 添加唯一索引
CREATE UNIQUE INDEX idx_alerts_unique_field ON alerts(unique_field);

-- 添加复合索引
CREATE INDEX idx_alerts_enterprise_metric ON alerts(enterprise_name, metric);
```

### 删除索引

```sql
DROP INDEX idx_alerts_priority;
```

### 添加约束

```sql
-- 添加非空约束
ALTER TABLE alerts 
ALTER COLUMN priority SET NOT NULL;

-- 添加检查约束
ALTER TABLE alerts 
ADD CONSTRAINT chk_priority 
CHECK (priority IN ('low', 'normal', 'high', 'urgent'));
```

---

## 推荐的工作流程

### 开发环境
1. 使用方法三（手动 SQL）快速测试
2. 确认无误后，使用方法一（Alembic）创建迁移脚本

### 生产环境
1. **必须使用方法一（Alembic）**
2. 先在测试环境验证迁移脚本
3. 备份数据库
4. 执行迁移
5. 验证数据完整性

---

## 示例：完整迁移流程

假设要添加一个 `severity`（严重程度）字段：

### 1. 修改模型 (`database.py`)

```python
class Alert(Base):
    # ... 现有字段 ...
    
    severity = Column(String(20), default="medium")  # 新增字段
```

### 2. 生成迁移

```bash
alembic revision --autogenerate -m "添加严重程度字段"
```

### 3. 检查迁移文件

查看 `alembic/versions/xxxx_add_severity.py`，确认 SQL 正确。

### 4. 执行迁移

```bash
alembic upgrade head
```

### 5. 验证

在 DBeaver 中查看表结构，确认新字段已添加。

---

## 注意事项

1. **备份数据**：修改数据库结构前，务必备份数据
2. **测试迁移**：在生产环境执行前，先在测试环境验证
3. **版本控制**：迁移脚本应该提交到版本控制系统
4. **回滚计划**：准备好回滚方案
5. **数据迁移**：如果需要迁移现有数据，在迁移脚本中添加数据转换逻辑

---

## Docker 环境中使用 Alembic

### 在容器内执行迁移

```bash
# 进入后端容器
docker-compose exec backend bash

# 执行迁移
alembic upgrade head
```

### 或者直接在主机执行（需要配置环境变量）

```bash
# 确保 DATABASE_URL 环境变量已设置
export DATABASE_URL=postgresql://alert_user:alert_password@localhost:5432/alert_db

# 执行迁移
alembic upgrade head
```

---

## 常见问题

**Q: 迁移失败怎么办？**
A: 使用 `alembic downgrade -1` 回滚到上一个版本，然后修复迁移脚本。

**Q: 如何查看迁移历史？**
A: `alembic history` 查看所有迁移记录。

**Q: 数据库结构已手动修改，Alembic 检测不到变化？**
A: 手动创建迁移：`alembic revision -m "描述"`，然后手动编写 `upgrade()` 和 `downgrade()` 函数。

**Q: 如何在迁移中执行数据迁移？**
A: 在迁移脚本中使用 `op.execute()` 执行 SQL：

```python
def upgrade() -> None:
    op.add_column('alerts', sa.Column('severity', sa.String(20)))
    # 迁移现有数据
    op.execute("UPDATE alerts SET severity = 'medium' WHERE severity IS NULL")
```



