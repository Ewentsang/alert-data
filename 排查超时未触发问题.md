# 排查超时未触发问题

## 可能的原因

### 1. 服务未重启
**问题**：代码已修改，但服务还在运行旧代码

**解决方案**：
```bash
# 重启后端服务
docker-compose restart backend

# 或完全重建
docker-compose down
docker-compose up -d --build
```

### 2. DIFY_WEBHOOK_URL_TIMEOUT 未配置
**问题**：如果未配置 `DIFY_WEBHOOK_URL_TIMEOUT`，超时通知不会发送，但字段应该仍然会更新

**检查方法**：
```bash
# 查看环境变量
docker-compose exec backend env | grep DIFY_WEBHOOK_URL_TIMEOUT

# 或查看 .env 文件
cat .env | grep DIFY_WEBHOOK_URL_TIMEOUT
```

**解决方案**：
在 `.env` 文件中配置：
```env
DIFY_WEBHOOK_URL_TIMEOUT=https://your-dify-workflow-url.com/webhook/timeout
```

### 3. 时区问题
**问题**：数据库中的时间可能没有时区信息，导致比较出错

**检查方法**：
在数据库中执行：
```sql
SELECT 
    id,
    alert_type,
    enterprise_name,
    alert_key,
    time,
    processed,
    timeout_triggered,
    NOW() as current_time,
    NOW() - time as time_diff,
    EXTRACT(EPOCH FROM (NOW() - time))/60 as minutes_diff
FROM alerts
WHERE alert_key = '企业 SHEIN 的420错误率超过阈值'
  AND alert_type = '告警触发'
ORDER BY created_at DESC;
```

### 4. 记录类型不正确
**问题**：从图片看，`om_type` 显示为"告警触发"，但应该是 `alert_type` 字段

**检查方法**：
```sql
SELECT 
    id,
    alert_type,  -- 这个字段应该是"告警触发"
    om_type,     -- 这个字段是 OM 类型，不是告警类型
    enterprise_name,
    alert_key,
    processed,
    timeout_triggered
FROM alerts
WHERE alert_key = '企业 SHEIN 的420错误率超过阈值';
```

### 5. 字段值问题
**问题**：`processed` 或 `timeout_triggered` 可能已经是 `True`（虽然显示为 `[]`）

**检查方法**：
```sql
SELECT 
    id,
    alert_type,
    processed,
    timeout_triggered,
    CASE 
        WHEN processed = true THEN '已处理'
        WHEN processed = false THEN '未处理'
        ELSE 'NULL'
    END as processed_status,
    CASE 
        WHEN timeout_triggered = true THEN '已触发'
        WHEN timeout_triggered = false THEN '未触发'
        ELSE 'NULL'
    END as timeout_status
FROM alerts
WHERE alert_key = '企业 SHEIN 的420错误率超过阈值';
```

## 排查步骤

### 步骤 1：检查服务状态和日志

```bash
# 查看服务状态
docker-compose ps

# 查看实时日志
docker-compose logs -f backend

# 查看最近的日志
docker-compose logs backend | tail -100

# 搜索超时相关日志
docker-compose logs backend | grep -i "超时\|timeout\|定期检查"
```

### 步骤 2：检查配置

```bash
# 检查环境变量
docker-compose exec backend env | grep -E "DIFY_WEBHOOK_URL_TIMEOUT|ALERT_TIMEOUT_MINUTES|CHECK_INTERVAL_SECONDS"
```

### 步骤 3：检查数据库记录

```sql
-- 检查这些记录的详细信息
SELECT 
    id,
    alert_type,
    enterprise_name,
    alert_key,
    time,
    processed,
    timeout_triggered,
    created_at,
    updated_at,
    -- 计算时间差（分钟）
    EXTRACT(EPOCH FROM (NOW() - time))/60 as minutes_since_alert
FROM alerts
WHERE alert_key = '企业 SHEIN 的420错误率超过阈值'
  AND alert_type = '告警触发'
ORDER BY created_at DESC;

-- 检查是否有匹配的告警恢复
SELECT 
    id,
    alert_type,
    enterprise_name,
    alert_key,
    time
FROM alerts
WHERE alert_type = '告警恢复'
  AND alert_key = '企业 SHEIN 的420错误率超过阈值';
```

### 步骤 4：手动触发检查

如果记录已经超过 20 分钟，可以：

1. **检查日志**，看定期检查任务是否在运行
2. **等待下一个检查周期**（每 60 秒检查一次）
3. **或者手动触发**（需要修改代码添加手动触发接口）

## 常见问题

### Q1: 为什么旧记录没有自动更新？

**A**: 旧记录是在代码修改之前创建的。定期检查任务会检查所有符合条件的记录，但需要等待下一个检查周期（每 60 秒）。

### Q2: 如何立即触发检查？

**A**: 可以重启服务，或者等待下一个检查周期。也可以临时修改 `CHECK_INTERVAL_SECONDS` 为更小的值（如 10 秒）来加快检查频率。

### Q3: 日志中没有看到超时相关的信息？

**A**: 可能的原因：
1. 日志级别设置问题
2. 定期检查任务没有运行
3. 记录不满足超时条件

检查方法：
```bash
# 查看所有日志级别
docker-compose logs backend | grep -E "INFO|WARNING|ERROR|DEBUG"
```

## 验证代码逻辑

确认以下逻辑是否正确：

1. **定期检查任务是否启动**：
   - 在 `startup_event()` 中启动
   - 每 60 秒运行一次

2. **查询条件是否正确**：
   - `alert_type == "告警触发"`
   - `processed == False`
   - `timeout_triggered == False`
   - `time <= cutoff_time`（当前时间 - 20分钟）

3. **时区处理是否正确**：
   - 使用北京时间进行比较
   - 处理没有时区信息的时间字段

## 快速修复建议

如果确认记录已经超过 20 分钟，可以：

1. **重启服务**（确保新代码运行）
2. **等待 1-2 分钟**（等待定期检查任务运行）
3. **查看日志**确认是否触发
4. **检查数据库**确认字段是否更新

如果仍然没有更新，请检查：
- 服务日志中的错误信息
- 数据库中的实际字段值
- 时区配置是否正确

