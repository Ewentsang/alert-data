# 系统使用完整指南

字段已更新完成！现在开始使用系统。

## ✅ 第一步：验证系统正常

### 1.1 检查服务状态

```bash
docker-compose ps
```

确保 `postgres` 和 `backend` 两个服务都在运行。

### 1.2 测试健康检查

访问：`http://localhost:8000/health`

应该返回：
```json
{"status": "ok"}
```

### 1.3 查看 API 文档

访问：`http://localhost:8000/docs`

这里可以看到所有可用的 API 接口。

---

## 🧪 第二步：测试创建告警数据

### 方式一：使用 API 文档（推荐，最简单）

1. 打开 `http://localhost:8000/docs`
2. 找到 `POST /api/alert` 接口
3. 点击 "Try it out"
4. 使用以下测试数据：

```json
{
  "input": "测试告警消息内容",
  "enterprise_name": "测试企业",
  "time": "2025-12-10 10:25:34",
  "alert_type": "告警触发",
  "template_name": "测试模板",
  "om_type": "ConnectionRate",
  "alert_key": "test_alert_001"
}
```

5. 点击 "Execute"
6. 应该返回创建的告警记录，包含 `id` 等信息

### 方式二：使用测试脚本

```bash
python test_api.py
```

### 方式三：使用 curl 命令

```bash
curl -X POST "http://localhost:8000/api/alert" \
  -H "Content-Type: application/json" \
  -d '{
    "input": "测试告警消息",
    "enterprise_name": "测试企业",
    "time": "2025-12-10 10:25:34",
    "alert_type": "告警触发",
    "template_name": "测试模板",
    "om_type": "ConnectionRate",
    "alert_key": "test_001"
  }'
```

---

## 📊 第三步：验证数据已写入数据库

### 在 DBeaver 中查看数据

```sql
-- 查看所有告警
SELECT * FROM alerts ORDER BY created_at DESC;

-- 查看最新的告警
SELECT 
    id,
    enterprise_name,
    alert_type,
    template_name,
    om_type,
    alert_key,
    time,
    created_at
FROM alerts
ORDER BY created_at DESC
LIMIT 5;
```

---

## 🔍 第四步：测试查询 API

### 查询所有告警

浏览器访问：`http://localhost:8000/api/alerts`

或使用 curl：
```bash
curl http://localhost:8000/api/alerts
```

### 按企业名称过滤

```
http://localhost:8000/api/alerts?enterprise_name=测试企业
```

### 按告警类型过滤

```
http://localhost:8000/api/alerts?alert_type=告警触发
```

### 查询单个告警

```
http://localhost:8000/api/alerts/{alert_id}
```

将 `{alert_id}` 替换为实际的告警 ID。

---

## ⚙️ 第五步：配置 Dify Workflow

### 5.1 配置环境变量

创建或编辑 `.env` 文件：

```env
# 接收告警数据的 webhook（可选）
DIFY_WEBHOOK_URL=https://api.dify.ai/v1/workflows/run

# 20分钟超时后触发的 webhook（必需）
DIFY_WEBHOOK_URL_TIMEOUT=https://your-dify-workflow-url.com/webhook/timeout

# 超时时间配置（分钟）
ALERT_TIMEOUT_MINUTES=20

# 检查间隔（秒）
CHECK_INTERVAL_SECONDS=60
```

### 5.2 在 Dify Workflow 中配置 API 调用

在你的 Dify workflow 中，添加一个 HTTP 请求节点：

**请求配置：**
- **URL**: `http://your-server:8000/api/alert` 或 `http://localhost:8000/api/alert`（如果是本地测试）
- **方法**: `POST`
- **Headers**:
  ```
  Content-Type: application/json
  ```
- **Body**:
  ```json
  {
    "input": "{{告警消息内容}}",
    "enterprise_name": "{{企业名称}}",
    "time": "{{告警时间}}",
    "alert_type": "{{告警类型}}",
    "template_name": "{{模板名称}}",
    "om_type": "{{OM类型}}",
    "alert_key": "{{告警唯一标识}}"
  }
  ```

**字段说明：**
- `input`: 告警消息的完整文本内容
- `enterprise_name`: 企业名称
- `time`: 告警时间，格式：`YYYY-MM-DD HH:MM:SS`
- `alert_type`: `"告警触发"` 或 `"告警恢复"`
- `template_name`: 模板名称/话术名称
- `om_type`: OM 类型（如 `ConnectionRate`）
- `alert_key`: 告警的唯一标识键（建议格式：`企业_模板_类型_时间戳`）

---

## 🔔 第六步：理解超时机制

### 工作原理

1. **接收"告警触发"消息**
   - 系统存储数据到数据库
   - 启动 20 分钟倒计时任务

2. **接收"告警恢复"消息**
   - 系统存储数据到数据库
   - 自动取消所有匹配的"告警触发"的超时通知
   - 匹配条件：`enterprise_name` 和 `alert_key` 相同
   - 一个"告警恢复"可以取消多个"告警触发"的超时通知

3. **20 分钟内没有收到匹配的"告警恢复"**
   - 系统自动调用 `DIFY_WEBHOOK_URL_TIMEOUT` 接口
   - 发送超时通知 payload（只包含三个字段）：
     ```json
     {
       "input": "测试告警消息",
       "enterprise_name": "测试企业",
       "time": "2025-12-10 10:25:34"
     }
     ```

### 测试超时机制（可选）

如果你想测试超时机制，可以：

1. 修改 `.env` 中的 `ALERT_TIMEOUT_MINUTES=1`（改为 1 分钟，方便测试）
2. 重启服务：`docker-compose restart backend`
3. 创建一个"告警触发"记录
4. 等待 1 分钟
5. 检查日志：`docker-compose logs backend`，应该看到超时通知被触发

---

## 📝 第七步：常用操作

### 查看服务日志

```bash
# 查看所有服务日志
docker-compose logs -f

# 只看后端日志
docker-compose logs -f backend

# 只看数据库日志
docker-compose logs -f postgres
```

### 重启服务

```bash
# 重启所有服务
docker-compose restart

# 重启特定服务
docker-compose restart backend
docker-compose restart postgres
```

### 停止服务

```bash
docker-compose down
```

### 启动服务

```bash
docker-compose up -d
```

---

## 📊 第八步：数据查询和分析

### 常用 SQL 查询

在 DBeaver 中可以执行：

```sql
-- 查看告警总数
SELECT COUNT(*) as total FROM alerts;

-- 按告警类型统计
SELECT 
    alert_type, 
    COUNT(*) as count 
FROM alerts 
GROUP BY alert_type;

-- 按企业统计
SELECT 
    enterprise_name, 
    COUNT(*) as count 
FROM alerts 
GROUP BY enterprise_name 
ORDER BY count DESC;

-- 按模板统计
SELECT 
    template_name, 
    COUNT(*) as count 
FROM alerts 
GROUP BY template_name 
ORDER BY count DESC;

-- 查看超时的告警
SELECT * 
FROM alerts 
WHERE timeout_triggered = true
ORDER BY created_at DESC;

-- 查看最近的告警（最近24小时）
SELECT * 
FROM alerts 
WHERE created_at > NOW() - INTERVAL '24 hours'
ORDER BY created_at DESC;

-- 查看未处理的告警触发
SELECT * 
FROM alerts 
WHERE alert_type = '告警触发' 
  AND timeout_triggered = false
ORDER BY time DESC;
```

---

## ✅ 完成检查清单

- [ ] 服务正常运行
- [ ] 表结构正确（12个字段）
- [ ] 可以创建告警记录
- [ ] 可以查询告警列表
- [ ] 数据正确写入数据库
- [ ] API 文档可以访问
- [ ] 配置了 `.env` 文件（特别是 `DIFY_WEBHOOK_URL_TIMEOUT`）
- [ ] 理解了超时机制
- [ ] 知道如何查看日志

---

## 🎉 系统已准备就绪！

现在你可以：
1. 在 Dify workflow 中配置 API 调用
2. 开始接收真实的告警数据
3. 系统会自动处理数据的存储和超时监控

如果遇到任何问题，查看日志或告诉我！


