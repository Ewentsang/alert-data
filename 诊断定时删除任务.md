# 定时删除任务诊断指南

## 问题现象
数据库中的旧数据没有被自动定时删除。

## 诊断步骤

### 1. 检查容器是否正在运行

```bash
# 在服务器上执行
docker-compose ps
# 或
docker ps | grep alert
```

### 2. 查看定时删除任务相关日志

```bash
# 查看后端服务日志，搜索定时删除相关记录
docker-compose logs backend | grep -i "定时删除"

# 或者查看最近的日志（最后100行）
docker-compose logs --tail 100 backend | grep -i "定时删除"

# 查看是否有任务启动记录
docker-compose logs backend | grep "定时删除任务调度器已启动"

# 查看是否有执行记录
docker-compose logs backend | grep "开始执行定时删除任务"

# 查看是否有错误记录
docker-compose logs backend | grep -i "定时删除.*错误\|定时删除.*error"
```

### 3. 检查容器重启历史

```bash
# 查看容器重启次数和最后启动时间
docker inspect alert_backend | grep -A 5 "State"

# 查看容器事件（重启记录）
docker events --since 24h --filter container=alert_backend
```

### 4. 检查当前时间和服务状态

```bash
# 进入容器检查时间
docker-compose exec backend date

# 检查 Python 进程
docker-compose exec backend ps aux | grep python

# 检查是否有定时任务在运行（通过日志）
docker-compose logs backend | tail -50
```

### 5. 手动触发删除任务（测试用）

如果需要验证删除逻辑是否正常，可以：

**方法1：通过 Python 脚本手动执行**

创建测试脚本 `test_delete.py`：
```python
import asyncio
from main import delete_old_alerts

async def test():
    await delete_old_alerts()

if __name__ == "__main__":
    asyncio.run(test())
```

然后在容器中执行：
```bash
docker-compose exec backend python test_delete.py
```

**方法2：添加临时 API 端点**

在 `main.py` 中添加一个测试端点（仅用于测试）：
```python
@app.post("/api/test/delete-old-alerts")
async def test_delete_old_alerts():
    """测试端点：手动触发删除旧数据"""
    await delete_old_alerts()
    return {"status": "ok", "message": "删除任务已执行，请查看日志"}
```

然后调用：
```bash
curl -X POST http://203.118.55.60:8088/api/test/delete-old-alerts
```

### 6. 常见问题排查

#### 问题1：容器频繁重启导致任务丢失
**检查方法：**
```bash
docker inspect alert_backend | grep RestartCount
docker-compose logs backend | grep -i "restart\|exit\|error"
```

**解决方案：**
- 检查健康检查配置
- 检查资源限制（内存、CPU）
- 查看应用错误日志

#### 问题2：时区问题
**检查方法：**
```bash
docker-compose exec backend date
docker-compose exec backend python -c "from datetime import datetime; print(datetime.now())"
```

**确认：** 容器时间应该是北京时间（UTC+8）

#### 问题3：任务在等待期间被中断
**检查方法：**
```bash
# 查看任务启动时间和计划执行时间
docker-compose logs backend | grep "下次执行时间"
```

**如果发现：**
- 任务启动后计划在第二天 00:00:05 执行
- 但容器在等待期间重启了
- 那么任务就会丢失

## 预期日志输出

### 正常情况下的日志应该包含：

1. **任务启动时：**
```
[定时删除] 定时删除任务调度器已启动，将在每天 00:00:05 执行删除
[定时删除] 下次执行时间: 2025-12-16 00:00:05, 等待 43564 秒
```

2. **执行删除时（每天 00:00:05）：**
```
[定时删除] 开始执行定时删除任务 - 当前时间: 2025-12-16 00:00:05
[定时删除] 删除时间范围: < 2025-12-16 00:00:00
[定时删除] 保留时间窗口: 2025-12-15 23:35:00 ~ 2025-12-16 00:00:00
[定时删除] ✅ 删除完成
[定时删除] 删除记录总数: X
```

3. **如果出错：**
```
[定时删除] ❌ 定时删除任务调度器出错: [错误信息]
```

## 快速诊断命令（一键执行）

```bash
#!/bin/bash
echo "=== 容器状态 ==="
docker-compose ps

echo -e "\n=== 定时删除任务启动记录 ==="
docker-compose logs backend | grep "定时删除任务调度器已启动" | tail -5

echo -e "\n=== 定时删除任务执行记录 ==="
docker-compose logs backend | grep "开始执行定时删除任务" | tail -5

echo -e "\n=== 定时删除任务错误记录 ==="
docker-compose logs backend | grep -i "定时删除.*错误\|定时删除.*error" | tail -5

echo -e "\n=== 容器重启次数 ==="
docker inspect alert_backend | grep RestartCount

echo -e "\n=== 当前容器时间 ==="
docker-compose exec backend date

echo -e "\n=== 下次计划执行时间（最新） ==="
docker-compose logs backend | grep "下次执行时间" | tail -1
```

## 建议的解决方案

如果确认是容器重启导致任务丢失，可以考虑：

1. **在启动时检查并执行延迟的删除任务**
2. **使用更可靠的任务调度机制（如 APScheduler）**
3. **添加任务执行状态监控和告警**
4. **使用外部任务调度器（如 cron）**

