# 告警处理逻辑流程说明

## 完整流程图

```
收到"告警触发"
    ↓
创建告警记录
    ↓
processed = False, timeout_triggered = False
    ↓
启动异步超时检查任务（等待10秒后检查）
    ↓
┌─────────────────────┬─────────────────────┐
│ 收到"告警恢复"       │ 10秒超时            │
│ (立即处理)          │ (异步任务或定期检查)│
└─────────────────────┴─────────────────────┘
    ↓                        ↓
查找匹配的"告警触发"     检查是否有"告警恢复"
(同enterprise_name和      (在10秒窗口内)
 alert_key)                ↓
    ↓                ┌──────────────┬──────────────┐
标记 processed = True │ 有告警恢复  │ 没有告警恢复 │
timeout_triggered保持False └──────────────┴──────────────┘
    ↓                        ↓                ↓
取消超时通知           不触发超时      触发超时通知
(异步任务会检测到         (已收到恢复)   timeout_triggered = True
 processed=True并退出)                  processed保持False
```

## 详细说明

### 1. 收到"告警触发"

**初始状态**：
- `processed = False`
- `timeout_triggered = False`

**操作**：
- 保存到数据库
- 启动异步超时检查任务（等待10秒后检查）

### 2. 收到"告警恢复"

**操作**：
- 立即查找所有匹配的"告警触发"记录
- 匹配条件：
  - `enterprise_name` 相同
  - `alert_key` 相同
  - `alert_type == "告警触发"`
  - `processed == False`
  - `timeout_triggered == False`
  - `time <= 告警恢复时间`（恢复时间晚于触发时间）

**更新状态**：
- 将匹配的"告警触发"记录的 `processed` 设置为 `True`
- `timeout_triggered` 保持 `False`

**结果**：
- 取消这些"告警触发"的超时通知
- 异步任务检测到 `processed = True` 后会退出

### 3. 超时触发

**触发条件**：
- 10秒内没有收到匹配的"告警恢复"
- `processed == False`（未收到告警恢复）
- `timeout_triggered == False`（未触发过超时）

**操作**：
- 调用 `trigger_timeout_workflow()` 发送到 Dify
- 将 `timeout_triggered` 设置为 `True`
- `processed` 保持 `False`

**结果**：
- 发送超时通知到 Dify Workflow
- 标记为已触发超时

## 字段状态组合

| processed | timeout_triggered | 含义 | 说明 |
|-----------|-------------------|------|------|
| `False` | `False` | 正常监控中 | 等待"告警恢复"或超时 |
| `True` | `False` | 已收到"告警恢复" | 超时通知被取消 |
| `False` | `True` | 已触发超时通知 | 10秒内未收到"告警恢复" |
| `True` | `True` | 理论上不应该出现 | 收到恢复后不会再超时 |

## 关键点

1. **收到"告警恢复"时**：立即处理，不等待超时
2. **超时触发时**：只更新 `timeout_triggered`，不更新 `processed`
3. **一个"告警恢复"可以取消多个"告警触发"**：只要匹配条件相同
4. **两种检查机制**：
   - 异步任务：单个告警的独立检查
   - 定期检查：每2秒检查所有告警（保障机制）

## 时间窗口

- **开始时间**：告警触发时间（数据库中的 `time` 字段）
- **结束时间**：告警触发时间 + 10秒（当前配置）
- **检查范围**：在这个时间窗口内是否有"告警恢复"

