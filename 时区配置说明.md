# 时区配置说明

项目已配置为使用**北京时间（UTC+8）**作为标准时区。

## ✅ 已完成的配置

### 1. 数据库时区配置

#### PostgreSQL（Docker 环境）
- 在 `docker-compose.yml` 中设置了 `TZ: Asia/Shanghai`
- 在数据库连接参数中设置了 `timezone=Asia/Shanghai`

#### SQLite（本地开发）
- 在应用层处理时区，所有时间都使用北京时间

### 2. 代码层面的时区处理

#### `database.py`
- 定义了 `BEIJING_TZ = timezone(timedelta(hours=8))`
- `created_at` 和 `updated_at` 字段使用 `beijing_now()` 函数
- 所有时间戳都自动使用北京时间

#### `parser.py`
- `parse_time()` 函数解析时间字符串时，自动添加北京时间时区
- 如果解析失败，使用当前北京时间

#### `main.py`
- 所有 `datetime.now()` 调用都改为 `datetime.now(beijing_tz)`
- 日志记录使用北京时间
- 超时检查使用北京时间

## 🔄 如何应用更改

### 方法 1：重启 Docker 服务（推荐）

```bash
# 停止服务
docker-compose down

# 重新启动（会应用新的时区配置）
docker-compose up -d --build
```

### 方法 2：仅重启后端服务

```bash
docker-compose restart backend
```

### 方法 3：本地运行

如果本地运行，直接重启 Python 服务即可：
```bash
# 停止当前服务（Ctrl+C）
# 重新运行
python main.py
```

## 📝 时间格式说明

### 输入时间格式

从 Dify 发送的时间字符串格式：
```
YYYY-MM-DD HH:MM:SS
```

例如：`2025-12-11 15:30:45`

**注意**：系统会假设输入的时间是北京时间，并自动添加时区信息。

### 数据库存储

- 所有时间字段都存储为带时区的时间戳
- `time` 字段：告警时间（北京时间）
- `created_at` 字段：记录创建时间（北京时间）
- `updated_at` 字段：记录更新时间（北京时间）

### API 返回格式

API 返回的时间格式为 ISO 8601 格式，包含时区信息：
```
2025-12-11T15:30:45+08:00
```

## 🔍 验证时区配置

### 方法 1：查看日志

日志中的时间戳应该显示北京时间：
```
2025-12-11 15:30:45,123 - __main__ - INFO - 收到请求: POST /api/alert
```

### 方法 2：查询数据库

```sql
-- 查看最新创建的告警记录
SELECT 
    id,
    enterprise_name,
    time,
    created_at,
    updated_at
FROM alerts
ORDER BY created_at DESC
LIMIT 5;
```

时间应该显示为北京时间。

### 方法 3：通过 API 查询

```bash
curl http://localhost:8000/api/alerts?limit=1
```

返回的 JSON 中，`time` 字段应该包含时区信息：
```json
{
  "time": "2025-12-11T15:30:45+08:00",
  ...
}
```

## ⚠️ 注意事项

1. **现有数据**：如果数据库中已有数据，它们的时间可能仍然是 UTC 时间。新插入的数据会使用北京时间。

2. **时区转换**：如果需要在不同时区之间转换，可以使用 Python 的 `datetime` 模块：
   ```python
   from datetime import datetime, timezone, timedelta
   
   # 北京时间
   beijing_tz = timezone(timedelta(hours=8))
   beijing_time = datetime.now(beijing_tz)
   
   # 转换为 UTC
   utc_time = beijing_time.astimezone(timezone.utc)
   ```

3. **Dify 时间格式**：确保从 Dify 发送的时间字符串格式正确：`YYYY-MM-DD HH:MM:SS`

4. **PostgreSQL 时区**：如果使用 PostgreSQL，数据库服务器本身也会使用 `Asia/Shanghai` 时区。

## 🐛 故障排查

### 问题 1：时间仍然显示 UTC

**解决方案**：
1. 确认已重启服务
2. 检查 `docker-compose.yml` 中的 `TZ: Asia/Shanghai` 配置
3. 查看日志确认时区设置

### 问题 2：时间相差 8 小时

**原因**：可能是时区配置未生效

**解决方案**：
1. 完全重启 Docker 服务：`docker-compose down && docker-compose up -d --build`
2. 检查数据库连接参数是否正确

### 问题 3：新数据时间正确，旧数据时间不对

**原因**：旧数据是在时区配置之前创建的

**解决方案**：
如果需要，可以编写迁移脚本将旧数据的时间转换为北京时间。

## 📚 相关文件

- `database.py` - 数据库时区配置
- `parser.py` - 时间解析函数
- `main.py` - 时间使用
- `docker-compose.yml` - PostgreSQL 时区环境变量

## ✅ 配置检查清单

- [ ] `docker-compose.yml` 中设置了 `TZ: Asia/Shanghai`
- [ ] `database.py` 中使用了 `beijing_now()` 函数
- [ ] `parser.py` 中时间解析添加了时区
- [ ] `main.py` 中所有时间操作使用北京时间
- [ ] 已重启服务应用更改
- [ ] 验证新插入的数据时间正确


