# 数据库状态检查指南

## 问题分析

从图片看到 DBeaver 中还是旧的字段结构（`region`, `metric`, `rule_name` 等），但代码已经更新为新字段。可能的原因：

1. **表没有被真正删除** - SQLAlchemy 的 `create_all()` 只会创建不存在的表，不会修改已存在的表
2. **后端服务没有重启** - 还在使用旧的代码或缓存的表结构
3. **连接到了错误的数据库或表**

## 检查步骤

### 步骤 1: 确认表是否真的被删除了

在 DBeaver 中执行：

```sql
-- 检查表是否存在
SELECT EXISTS (
    SELECT FROM information_schema.tables 
    WHERE table_schema = 'public' 
    AND table_name = 'alerts'
);
```

如果返回 `true`，说明表还存在。

### 步骤 2: 查看当前表的实际结构

```sql
-- 查看表的所有字段
SELECT 
    column_name,
    data_type,
    character_maximum_length,
    is_nullable
FROM information_schema.columns
WHERE table_name = 'alerts'
ORDER BY ordinal_position;
```

这会显示表**实际**有哪些字段。

### 步骤 3: 检查后端服务状态

```bash
# 查看服务状态
docker-compose ps

# 查看后端服务日志，看是否有错误
docker-compose logs backend | tail -50
```

### 步骤 4: 确认代码是否已更新

检查 Docker 容器内是否使用的是最新代码：

```bash
# 进入后端容器
docker-compose exec backend bash

# 查看 database.py 文件内容
cat database.py | grep -A 20 "class Alert"
```

应该看到新字段（`input`, `template_name`, `om_type`, `alert_key`），而不是旧字段。

### 步骤 5: 确认表创建时间

```sql
-- 查看表的创建时间（PostgreSQL）
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE tablename = 'alerts';
```

## 可能的问题和解决方案

### 问题 1: 表没有被删除

**现象：** `SELECT EXISTS` 返回 `true`，且字段还是旧的

**原因：** 你执行了 `DROP TABLE`，但可能：
- 在错误的数据库中执行
- 执行失败但没有报错
- 事务未提交

**解决：**

```sql
-- 1. 确认连接的数据库
SELECT current_database();

-- 2. 确认表是否存在
\dt alerts

-- 3. 强制删除表（如果有外键约束）
DROP TABLE IF EXISTS alerts CASCADE;

-- 4. 确认表已删除
SELECT EXISTS (
    SELECT FROM information_schema.tables 
    WHERE table_schema = 'public' 
    AND table_name = 'alerts'
);
-- 应该返回 false
```

### 问题 2: 后端服务没有重启

**现象：** 代码已更新，但表结构没变

**原因：** 
- 容器还在运行旧代码
- 需要重新构建镜像

**解决：**

```bash
# 停止服务
docker-compose down

# 重新构建并启动
docker-compose up -d --build

# 查看日志确认表已创建
docker-compose logs backend | grep -i "create\|table"
```

### 问题 3: 代码没有真正更新到容器

**现象：** 本地代码已更新，但容器内还是旧代码

**原因：** Docker 镜像缓存或卷挂载问题

**解决：**

```bash
# 强制重新构建（不使用缓存）
docker-compose build --no-cache backend

# 重启服务
docker-compose up -d backend

# 确认代码已更新
docker-compose exec backend cat database.py | grep "template_name"
```

### 问题 4: DBeaver 缓存了表结构

**现象：** 数据库中表结构已更新，但 DBeaver 显示还是旧的

**解决：**

1. 在 DBeaver 中右键点击 `alerts` 表
2. 选择 **刷新** 或 **Refresh**
3. 或者断开连接后重新连接

## 推荐操作流程

按照以下顺序执行：

### 1. 确认表结构（DBeaver）

```sql
SELECT column_name 
FROM information_schema.columns 
WHERE table_name = 'alerts' 
ORDER BY ordinal_position;
```

### 2. 如果字段还是旧的，删除表

```sql
DROP TABLE IF EXISTS alerts CASCADE;
```

### 3. 确认表已删除

```sql
SELECT EXISTS (
    SELECT FROM information_schema.tables 
    WHERE table_schema = 'public' 
    AND table_name = 'alerts'
);
-- 应该返回 false
```

### 4. 重启后端服务

```bash
docker-compose restart backend
```

或者完全重建：

```bash
docker-compose down
docker-compose up -d --build
```

### 5. 查看日志确认表已创建

```bash
docker-compose logs backend
```

应该看到类似 `CREATE TABLE alerts` 的日志。

### 6. 再次检查表结构（DBeaver）

```sql
SELECT column_name 
FROM information_schema.columns 
WHERE table_name = 'alerts' 
ORDER BY ordinal_position;
```

现在应该看到新字段：
- id
- input
- enterprise_name
- time
- alert_type
- template_name
- om_type
- alert_key
- processed
- timeout_triggered
- created_at
- updated_at

### 7. 刷新 DBeaver

右键表 → **刷新**，确认界面显示也更新了。

---

## 快速诊断命令

一次性执行所有检查：

```sql
-- 在 DBeaver 中执行
SELECT 
    'Table exists: ' || EXISTS (
        SELECT FROM information_schema.tables 
        WHERE table_schema = 'public' 
        AND table_name = 'alerts'
    ) as status,
    COUNT(*) as column_count,
    string_agg(column_name, ', ' ORDER BY ordinal_position) as columns
FROM information_schema.columns
WHERE table_name = 'alerts';
```

这会显示：
- 表是否存在
- 有多少个字段
- 所有字段名称

如果看到 `region`, `metric`, `rule_name` 等，说明表结构还是旧的。


